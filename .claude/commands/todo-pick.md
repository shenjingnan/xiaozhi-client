---
description: 推荐下一个要处理的待办事项
---

# 推荐下一个要处理的待办事项

你正在帮助用户从 `todos/` 目录中选择最适合当前处理的待办事项。这个命令会分析所有待处理的 todo，从多个维度评估优先级，并推荐最合适的处理顺序。

## 分析阶段

### 步骤 1：读取所有 Todo 文件

使用 Glob 工具获取 `todos/` 目录下的所有 `.md` 文件：
```bash
todos/*.md
```

### 步骤 2：解析 Todo 信息

对每个 todo 文件，使用 Read 工具读取内容，提取以下信息：

1. **标题**：从文件名或一级标题提取
2. **背景**：了解任务来源和重要性
3. **为什么 Todo**：了解为什么之前没有处理
4. **合适的处理时机**：了解何时应该处理
5. **影响范围**：评估工作量
6. **相关 Issue/PR**：了解关联信息

### 步骤 3：多维度评估

对每个 todo 从以下维度进行评估：

#### 3.1 优先级（Priority）

**评估标准**：
- **高优先级**：
  - 影响系统稳定性
  - 阻碍其他功能开发
  - 安全相关问题
  - 性能瓶颈问题

- **中优先级**：
  - 代码质量问题
  - 技术债务清理
  - 维护性改进

- **低优先级**：
  - 命名规范统一
  - 文档完善
  - 优化型改进

**分值**：高=5，中=3，低=1

#### 3.2 处理时机（Timing）

**评估标准**：
- **立即处理**：
  - 当前系统存在问题
  - 正在处理相关功能
  - 阻塞其他开发

- **尽快处理**：
  - 技术债务累积
  - 后续开发的基础
  - 依赖即将变更

- **合适时机**：
  - 版本迭代间隙
  - 维护窗口期
  - 无紧急任务时

- **版本间隙**：
  - 大型重构任务
  - 非关键路径任务

**分值**：立即=5，尽快=4，合适=3，间隙=1

#### 3.3 依赖关系（Dependency）

**评估标准**：
- **独立任务**：不影响其他任务，可随时处理 → 分值 3
- **前置依赖**：是其他任务的前置条件 → 分值 5
- **有依赖**：依赖其他任务完成 → 分值 1
- **复杂依赖**：涉及多个依赖关系 → 分值 0

#### 3.4 工作量（Effort）

**评估标准**：
- **小任务**：< 1 小时 → 分值 3
- **中等任务**：1-4 小时 → 分值 2
- **大任务**：4-8 小时 → 分值 1
- **超大型任务**：> 8 小时 → 分值 0

根据"影响范围"中的文件数量和改动复杂度评估：
- 文件数量 ≤ 3：小任务
- 文件数量 4-10：中等任务
- 文件数量 11-20：大任务
- 文件数量 > 20：超大型任务

#### 3.5 风险评估（Risk）

**评估标准**：
- **低风险**：改动集中，影响范围可控 → 分值 0
- **中风险**：涉及核心模块，需要仔细测试 → 分值 -1
- **高风险**：大规模重构，可能影响稳定性 → 分值 -2

### 步骤 4：计算推荐分数

使用以下公式计算每个 todo 的推荐分数：

```
总分 = 优先级分数 × 5 + 时机分数 × 4 + 独立性分数 × 3 + 工作量分数 - 风险惩罚
```

**分数解释**：
- 分数 ≥ 30：强烈推荐
- 分数 20-29：推荐
- 分数 10-19：可考虑
- 分数 < 10：暂不推荐

## 推荐阶段

### 步骤 5：生成推荐报告

向用户展示推荐报告，格式如下：

```markdown
# Todo 处理推荐报告

分析时间：2025-01-29
待处理 Todo 总数：3

---

## 🎯 强烈推荐

### 1. 统一 API 响应格式（分数：35）

**优先级**: 中（代码质量）
**处理时机**: 尽快处理（技术债务）
**独立性**: 独立任务
**工作量**: 中等（9 个文件）
**风险评估**: 低

**推荐理由**:
- ✅ 改动集中在 handlers 目录，影响范围可控
- ✅ 可以按文件逐个处理，风险低
- ✅ 已经是最后一次统一规范的机会
- ✅ 不影响其他功能开发

**处理建议**:
1. 选择一个模块的 handler（如 `ConfigApiHandler.ts`）
2. 替换 `c.json()` 为 `c.success()` 或 `c.fail()`
3. 运行测试验证
4. 提交后继续下一个

**预计耗时**: 2-3 小时

---

## 📋 可以考虑

### 2. Handlers 命名规范统一（分数：18）

**优先级**: 低（命名规范）
**处理时机**: 合适时机（规范统一）
**独立性**: 独立任务
**工作量**: 大（14 个文件）
**风险评估**: 中

**推荐理由**:
- ✅ 命名规范统一有助于代码可读性
- ⚠️ 涉及文件较多，需要批量处理
- ⚠️ 需要更新所有导入语句

**处理建议**:
- 等待 `endpoint.handler.ts` 命名方式验证通过后
- 安排专门的代码质量周进行批量处理
- 或者在修改某个 handler 时顺便重命名

**预计耗时**: 4-6 小时

---

## ⏸️ 暂不推荐

### 3. 迁移 EventBus 到 mitt（分数：8）

**优先级**: 中（技术债务）
**处理时机**: 版本间隙（大型重构）
**独立性**: 有依赖（需要测试覆盖完善）
**工作量**: 超大型（40+ 文件）
**风险评估**: 高

**推荐理由**:
- ✅ 可以减少 400+ 行自定义代码
- ❌ 当前 EventBus 运行稳定，非紧急任务
- ❌ 涉及文件多，测试工作量大
- ❌ 建议在版本间隙有专门时间窗口时处理

**处理建议**:
- 等待当前版本核心功能开发完成
- 确保测试覆盖率达到 80% 以上
- 安排专门的维护窗口期进行迁移
- 建议分阶段进行：创建适配层 → 逐步迁移 → 清理旧代码

**预计耗时**: 8-12 小时

---

## 推荐总结

**最佳选择**: 统一 API 响应格式
- 风险低，工作量适中
- 可以碎片时间处理
- 完成后代码质量提升明显

**备选方案**: Handlers 命名规范统一
- 可以在修改其他功能时顺便处理
- 不需要专门的时间窗口

**长期规划**: EventBus 迁移
- 建议在版本间隙处理
- 需要充分的前期准备和测试
```

## 输出阶段

### 步骤 6：提供详细处理指南

对于推荐的 todo，提供详细的处理指南：

```markdown
## 推荐任务详细指南

### 任务：统一 API 响应格式

#### 背景
当前 handlers 中仍有使用 `c.json()` 返回响应的情况，需要统一使用 `c.success()` 和 `c.fail()` 方法。

#### 影响范围
- 9 个 handler 文件需要修改
- 主要是替换响应方法调用

#### 处理步骤
1. 选择一个文件（如 `ConfigApiHandler.ts`）
2. 查找所有 `c.json()` 调用
3. 根据场景判断是成功还是失败
4. 替换为 `c.success()` 或 `c.fail()`
5. 运行测试验证
6. 提交改动

#### 开始命令
```
# 查看当前状态
grep -r "c.json()" apps/backend/handlers/

# 开始修改第一个文件
# 建议从 `ConfigApiHandler.ts` 开始
```

#### 完成标准
- 所有 `c.json()` 调用已替换
- 测试全部通过
- 代码符合 lint 规范

#### 预期效果
- API 响应格式统一
- 代码可读性提升
- 错误处理更规范
```

## 评估维度详解

### 优先级判断矩阵

| 场景 | 优先级 | 说明 |
|-----|-------|------|
| 影响系统稳定性 | 高 | 可能导致崩溃或数据丢失 |
| 阻碍功能开发 | 高 | 其他任务的前置条件 |
| 安全漏洞 | 高 | 需要立即修复 |
| 性能瓶颈 | 高 | 影响用户体验 |
| 代码质量 | 中 | 技术债务，不紧急但重要 |
| 可维护性 | 中 | 影响开发效率 |
| 命名规范 | 低 | 不影响功能，仅影响可读性 |
| 文档完善 | 低 | 非关键任务 |

### 时机判断矩阵

| 信号 | 时机 | 说明 |
|-----|------|------|
| 正在处理相关功能 | 立即 | 顺手处理，效率最高 |
| 技术债务累积 | 尽快 | 避免债务过重 |
| 前置条件已满足 | 尽快 | 可以开始处理 |
| 版本开发间隙 | 合适 | 有专门时间窗口 |
| 无紧急任务 | 合适 | 利用空闲时间 |
| 大型重构任务 | 版本间隙 | 需要充分时间 |
| 非核心优化 | 版本间隙 | 不影响功能迭代 |

### 工作量评估矩阵

| 文件数量 | 预计耗时 | 工作量等级 |
|---------|---------|-----------|
| 1-3 | < 1 小时 | 小 |
| 4-10 | 1-4 小时 | 中 |
| 11-20 | 4-8 小时 | 大 |
| > 20 | > 8 小时 | 超大型 |

### 风险评估矩阵

| 风险因素 | 风险等级 | 说明 |
|---------|---------|------|
| 改动集中 | 低 | 影响范围可控 |
| 有完善测试 | 低 | 可以快速验证 |
| 涉及核心模块 | 中 | 需要仔细测试 |
| 大规模重构 | 高 | 可能影响稳定性 |
| 缺少测试覆盖 | 高 | 难以验证正确性 |

## 边界情况处理

### 无待处理 Todo

如果 todos/ 目录为空或所有 todo 都已完成：

```markdown
# Todo 处理推荐报告

当前没有待处理的 todo 文件！🎉

可以考虑：
1. 检查是否有新的技术债务需要记录
2. 使用 `/todo` 命令创建新的待办事项
3. 继续推进当前的功能开发
```

### 无法评估的 Todo

如果 todo 文件格式不完整或信息缺失：

```markdown
## ⚠️ 无法评估

### [Todo 标题]

**原因**: 缺少关键信息（如"影响范围"、"合适的处理时机"）

**建议**: 更新 todo 文档，补充必要信息后再评估
```

### 优先级冲突

当多个 todo 分数相同时：

1. 优先选择"小任务"：快速完成，获得成就感
2. 优先选择"独立任务"：不依赖其他条件
3. 优先选择"低风险"：降低失败概率
4. 优先选择"接近完成"：利用已有进度

## 完成后操作

推荐结束后，询问用户：

```markdown
## 下一步操作

根据推荐，建议您：

1. **开始处理推荐任务**: 统一 API 响应格式
2. **了解更多详情**: 查看具体的 todo 文档
3. **重新评估**: 如果优先级有变化，重新分析

您想做什么？
- 输入 "开始" 处理推荐任务
- 输入 "详情" 查看 todo 文档内容
- 输入 "重新" 重新评估优先级
```

## 输出语言

所有输出文本使用中文，与现有命令风格保持一致。
