---
description: 清理已完成的待办事项文档
---

# 清理已完成的待办事项

你正在帮助用户清理 `todos/` 目录中已完成的待办事项文档。这个命令会分析每个 todo 的完成状态，并在用户确认后删除已完成的 todo 文件。

## 分析阶段

### 步骤 1：读取所有 Todo 文件

使用 Glob 工具获取 `todos/` 目录下的所有 `.md` 文件：
```bash
todos/*.md
```

### 步骤 2：解析每个 Todo 文件

对每个 todo 文件，使用 Read 工具读取内容，然后解析以下关键信息：

1. **待删除/修改的文件**：从"影响范围"部分提取文件路径
2. **待检查的模式**：从"正确的处理方法"部分提取搜索模式
3. **完成标准**：从"合适的处理时机"部分提取判断依据

### 步骤 3：执行完成状态检查

对每个 todo 执行以下检查：

#### 3.1 文件存在性检查

对于标记为"待删除"的文件，使用 Glob 工具检查文件是否仍存在：
```bash
apps/backend/services/<filename>.ts
```

- 如果文件不存在 → 可能已完成
- 如果文件存在 → 需要进一步检查

#### 3.2 代码模式检查

使用 Grep 工具搜索关键模式：

**检查旧类/函数名是否存在**：
```bash
# 检查类名
grep -r "class LoadBalancer" apps/backend/

# 检查导入语句
grep -r "import.*LoadBalancer" apps/backend/

# 检查使用
grep -r "new LoadBalancer" apps/backend/
```

**检查新的命名规范是否已应用**：
```bash
# 检查是否还有旧的命名模式
grep -r "c.json()" apps/backend/handlers/

# 检查新的响应方法使用
grep -r "c.success()" apps/backend/handlers/
```

#### 3.3 完成度评估

根据检查结果计算完成度：

| 检查项 | 权重 | 说明 |
|-------|------|------|
| 待删除文件已删除 | 40% | 文件不存在视为完成 |
| 导入语句已清理 | 20% | 无相关导入 |
| 代码引用已移除 | 20% | 无使用痕迹 |
| 新方案已实施 | 20% | 新模式已应用 |

**完成度判断标准**：
- **100% 完成**：所有检查项都通过
- **>80% 接近完成**：主要检查项通过，少量遗留
- **<80% 未完成**：多个检查项未通过

## 报告阶段

### 步骤 4：生成完成报告

向用户展示分析报告，格式如下：

```markdown
# Todo 完成状态分析报告

分析时间：2025-01-29
Todo 总数：4

## ✅ 已完成（建议删除）

### 1. 移除旧的负载均衡逻辑

**完成度**: 100%
**证据**:
- ✅ `LoadBalancer.ts` 文件已删除
- ✅ 无 `import.*LoadBalancer` 引用
- ✅ 无 `class LoadBalancer` 定义

**建议**: 可以安全删除此 todo 文件

---

## ⚠️ 接近完成（90%+）

### 2. 统一 API 响应格式

**完成度**: 90%
**证据**:
- ✅ 8/9 个 handler 已迁移到 `c.success()`
- ⚠️ `ServiceApiHandler.ts` 仍有 1 处 `c.json()` 调用

**建议**: 可以先完成剩余工作再删除，或保留到下次处理

---

## ⏸️ 待处理

### 3. 迁移 EventBus 到 mitt

**完成度**: 0%
**证据**:
- ❌ `EventBus.ts` 文件仍存在（456 行）
- ❌ 40+ 文件仍在使用旧 EventBus
- ❌ mitt 依赖未安装

**建议**: 保留此 todo 文件

---

## 统计

- ✅ 已完成: 1 个
- ⚠️ 接近完成: 1 个
- ⏸️ 待处理: 2 个
```

## 执行阶段

### 步骤 5：用户确认

在执行删除前，向用户确认：

```markdown
## 确认删除

根据分析，以下 todo 文件可以安全删除：

1. `todos/2025-01-23-remove-old-load-balancer.md`
2. ...

是否继续删除这些文件？

**注意**:
- 删除前建议运行 `pnpm test` 确保测试通过
- 删除后可以通过 git 恢复
- 建议先提交当前工作，避免混入其他改动

输入 "yes" 确认删除，或输入 "no" 取消操作。
```

### 步骤 6：安全删除

仅在用户确认后执行删除：

1. **安全检查**：建议用户先运行测试
   ```bash
   pnpm test
   ```

2. **执行删除**：使用 Bash 工具删除文件
   ```bash
   rm todos/2025-01-23-remove-old-load-balancer.md
   ```

3. **验证结果**：确认文件已删除

## 注意事项

### 安全机制

1. **先分析后删除**：始终先展示完整报告
2. **证据充分**：为每个判断提供具体代码证据
3. **用户确认**：必须用户明确确认才执行删除
4. **可逆性提醒**：告知用户可以通过 git 恢复

### 边界情况处理

1. **Todo 文件格式不一致**：
   - 如果缺少"影响范围"字段，标记为"无法评估"
   - 如果文件损坏，向用户报告

2. **部分完成的情况**：
   - >80% 完成度标记为"接近完成"
   - 让用户决定是否删除或继续处理

3. **跨模块影响**：
   - 检查范围要覆盖 `apps/backend/`、`packages/cli/`、`apps/frontend/`
   - 确保没有遗漏的引用

## 完成后操作

删除完成后，向用户报告：

```markdown
## 清理完成

已删除以下 todo 文件：
- ✅ `todos/2025-01-23-remove-old-load-balancer.md`

剩余待处理 todo：
- ⚠️ `todos/2025-01-23-unify-api-response-format.md` (90% 完成)
- ⏸️ `todos/2026-01-24-migrate-to-mitt.md` (0% 完成)

建议：
- 考虑完成 API 响应格式统一的剩余工作
- EventBus 迁移可以安排在版本间隙处理
```

## 输出语言

所有输出文本使用中文，与现有命令风格保持一致。
