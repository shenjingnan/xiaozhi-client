# GitHub Copilot Code Review 指导

## 基础规则

1. Code Review 评论内容请使用中文
2. 专注于提供有价值、可操作的建议，避免指出显而易见的问题

## CR 优先级框架

### 🔴 高优先级（必须评论）

- **安全问题**：输入验证、SQL 注入、XSS、权限控制等
- **性能问题**：算法复杂度过高、内存泄漏、不必要的循环等
- **关键逻辑错误**：业务逻辑缺陷、边界条件处理不当
- **架构一致性**：违反项目架构模式、模块职责不清
- **TypeScript 类型安全**：类型滥用、any 类型的不当使用

### 🟡 中优先级（建议评论）

- **API 设计**：接口一致性、参数设计、返回值结构
- **错误处理**：异常处理不完整、错误信息不清晰
- **代码可读性**：复杂的业务逻辑需要更好的注释或重构
- **测试质量**：测试覆盖率不足、测试用例设计不合理

### 🟢 低优先级（避免评论）

- **格式问题**：缩进、空格、换行等（应由自动化工具处理）
- **命名风格**：除非严重影响理解
- **个人编码偏好**：不影响功能实现的习惯性写法

## 项目特定指导

### MCP 协议实现

- 关注 MCP 消息处理的正确性和完整性
- 检查传输适配器的错误处理和重连机制
- 验证工具调用和资源管理的生命周期

### TypeScript 最佳实践

- 优先使用具体的类型而非 `any`
- 鼓励使用类型推导和泛型
- 检查接口设计的一致性和向后兼容性

### 模块化架构

- 验证模块间的依赖关系是否合理
- 检查单一职责原则的遵循
- 确保依赖注入容器的正确使用

### 测试策略

- 重点检查集成测试和端到端测试
- 验证异步代码的正确测试
- 关注测试的可维护性和可读性

## 评论质量标准

### ✅ 好的评论应该

1. **解释原因**：说明为什么需要这个改动
2. **提供方案**：给出具体的修改建议
3. **考虑影响**：说明改动可能对其他部分的影响
4. **示例代码**：在需要时提供代码示例

### ❌ 避免的评论类型

1. **仅指出问题**："这里有问题"、"这样不好"
2. **模糊建议**："建议重构"、"优化一下"
3. **过度建议**：针对边缘案例的过度设计
4. **风格偏好**：个人习惯相关的评论

## 技术债务关注点

### 可维护性

- 代码重复
- 过长的函数或类
- 深层嵌套的复杂逻辑

### 可扩展性

- 硬编码的配置和常量
- 缺乏抽象的重复代码
- 紧耦合的组件设计

### 可测试性

- 难以测试的代码结构
- 过多的外部依赖
- 缺乏依赖注入

## 具体示例

### 好的评论示例

````
🔴 **安全问题**：这个函数直接使用用户输入构建 SQL 查询，存在 SQL 注入风险。

建议：使用参数化查询或 ORM 的查询构建器来避免 SQL 注入。

```typescript
// 当前代码（不安全）
const query = `SELECT * FROM users WHERE name = '${userName}'`;

// 建议改为
const query = 'SELECT * FROM users WHERE name = ?';
db.query(query, [userName]);
````

```

### 应该避免的评论
```

❌ "这个函数太长了"（没有具体建议）
❌ "变量名应该用 camelCase"（自动化工具应处理）
❌ "建议用 async/await"（没有说明具体收益）

```

## 上下文理解

1. **理解改动目的**：在评论前先理解这个 PR 的目标
2. **考虑整体影响**：不要只关注局部代码片段
3. **平衡建议**：在完美主义和实用性之间找到平衡
4. **尊重设计决策**：除非有明确问题，否则尊重现有的架构选择

通过遵循这些指导，Copilot 将提供更有价值、更符合人类标准的 Code Review。
```

## 自动创建 PR 判断

在完成代码审查和修改后，需要判断是否应该自动创建 Pull Request。

### 判断标准

**应该创建 PR 的情况：**

1. **代码修改已完成**：所有要求的改动都已实现并提交
2. **测试通过**：相关测试用例均已通过
3. **类型检查通过**：TypeScript 类型检查无错误
4. **Lint 检查通过**：代码风格检查无错误
5. **有实质性改动**：改动包含功能新增、bug 修复或重要重构
6. **尚未创建 PR**：当前分支还没有对应的 Pull Request

**不应该创建 PR 的情况：**

1. **仅代码审查**：只是进行代码审查，没有实际修改代码
2. **改动未完成**：还有待完成的任务或已知问题
3. **测试失败**：存在未通过的测试用例
4. **类型错误**：存在 TypeScript 类型错误
5. **轻微改动**：仅修改注释、格式或非关键调整
6. **已存在 PR**：当前分支已有对应的 Pull Request

### PR 创建流程

当满足创建 PR 的条件时：

1. **确认分支状态**：确保当前分支有未推送的提交
2. **推送分支**：将当前分支推送到远程仓库
3. **生成 PR 信息**：
   - 基于 git diff 生成符合规范的标题
   - 生成包含"为什么改"、"改了什么"、"影响范围"、"验证方式"的描述
   - 在描述末尾添加签名：`Generated with [Claude Code](https://claude.ai/code)`
4. **创建 PR**：使用 `gh pr create` 命令创建 Pull Request
5. **返回 PR 链接**：向用户提供创建的 PR 链接

### PR 信息模板

```markdown
## 改动说明

### 为什么改
<改动动机和问题背景>

### 改了什么
<具体的改动内容>

### 影响范围
<受影响的模块和兼容性>

### 验证方式
<测试方法或验证点>

---

Generated with [Claude Code](https://claude.ai/code)
```

### 注意事项

- PR 标题应使用中文，符合 git commit 规范
- 如果主分支不是 `main`，应自动检测并使用正确的主分支名称
- 创建 PR 前应确保所有代码检查都已通过（`pnpm check:all`）
- 不要为文档注释、格式调整等轻微改动创建 PR
