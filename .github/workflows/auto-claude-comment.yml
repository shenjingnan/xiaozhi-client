name: Auto Claude Comment

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: "*/10 * * * *" # 每10分钟执行一次

permissions:
  issues: write
  contents: write  # 需要 contents 权限来触发 repository_dispatch

jobs:
  auto-comment:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: 启用 Corepack
        run: corepack enable

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/iron"
          cache: "pnpm"

      - name: 安装依赖
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          retry_on: error
          command: pnpm install

      - name: 检查并触发 Claude 处理
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取最新的10个打开的 issue
          issues=$(gh issue list --limit 10 --state open --json number)

          # 遍历每个 issue
          echo "$issues" | jq -r '.[].number' | while read -r issue_number; do
            # 检查是否已有 @claude 评论（避免重复触发）
            has_claude=$(gh issue view "$issue_number" --json comments -q '.comments[].body' | grep -c "@claude" || true)

            if [ "$has_claude" -eq 0 ]; then
              echo "为 issue #$issue_number 添加 @claude 评论并触发 Claude workflow"
              # 添加评论（作为记录）
              gh issue comment "$issue_number" --body "@claude"

              # 使用 repository_dispatch 触发 claude.yml workflow
              # 这是 GitHub 官方支持的 workflow 间通信方式
              gh api \
                --method POST \
                -H "Accept: application/vnd.github.v3+json" \
                "/repos/${GITHUB_REPOSITORY}/dispatches" \
                -f event_type="claude_issue_trigger" \
                -f client_payload="{\"issue_number\":$issue_number}"
            else
              echo "issue #$issue_number 已有 @claude 评论，跳过"
            fi
          done
