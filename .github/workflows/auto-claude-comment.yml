name: Auto Claude Comment

on:
  workflow_dispatch: # 手动触发
  schedule:
    - cron: "*/10 * * * *" # 每10分钟执行一次

permissions:
  issues: write
  contents: write  # 需要 contents 权限来触发 repository_dispatch

jobs:
  auto-comment:
    runs-on: ubuntu-latest
    steps:
      - name: 检查执行时间
        id: check_time
        if: github.event_name == 'schedule'
        run: |
          # 获取当前 UTC 时间的小时数 (0-23)
          HOUR=$(date -u +"%H")
          # 北京时间 00:00-06:00 对应 UTC 16:00-22:00
          # 检查是否在允许的时间范围内
          if [ "$HOUR" -ge 16 ] && [ "$HOUR" -lt 22 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "当前时间 UTC ${HOUR}:xx (北京时间 $(($HOUR+8))%24:xx)，允许执行"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "当前时间 UTC ${HOUR}:xx (北京时间 $(($HOUR+8))%24:xx)，不在执行时间范围内"
          fi

      - name: 检出代码
        if: github.event_name != 'schedule' || steps.check_time.outputs.should_run == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: 启用 Corepack
        if: github.event_name != 'schedule' || steps.check_time.outputs.should_run == 'true'
        run: corepack enable

      - name: 安装 pnpm
        if: github.event_name != 'schedule' || steps.check_time.outputs.should_run == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: 设置 Node.js
        if: github.event_name != 'schedule' || steps.check_time.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "lts/iron"
          cache: "pnpm"

      - name: 安装依赖
        if: github.event_name != 'schedule' || steps.check_time.outputs.should_run == 'true'
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          retry_on: error
          command: pnpm install

      - name: 检查并触发 Claude 处理
        if: github.event_name != 'schedule' || steps.check_time.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # 获取最新的10个打开的 issue
          issues=$(gh issue list --limit 10 --state open --json number)

          # 遍历每个 issue
          echo "$issues" | jq -r '.[].number' | while read -r issue_number; do
            # 检查是否已有 @claude 评论（避免重复触发）
            has_claude=$(gh issue view "$issue_number" --json comments -q '.comments[].body' | grep -c "@claude" || true)

            if [ "$has_claude" -eq 0 ]; then
              echo "为 issue #$issue_number 添加 @claude 评论并触发 Claude workflow"
              # 添加评论（作为记录）
              gh issue comment "$issue_number" --body "@claude"
            else
              echo "issue #$issue_number 已有 @claude 评论，跳过"
            fi
          done
