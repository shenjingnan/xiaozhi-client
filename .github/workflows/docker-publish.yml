name: Docker å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      version:
        description: "è¦å‘å¸ƒçš„ç‰ˆæœ¬å·ï¼ˆä¸å¸¦ 'v' å‰ç¼€ï¼Œä¾‹å¦‚ï¼š1.2.3ï¼‰"
        required: false
        type: string
      branch:
        description: "å‘å¸ƒæºåˆ†æ”¯"
        required: true
        default: "main"
        type: choice
        options:
          - main
          - beta
      force_latest:
        description: "å¼ºåˆ¶æ›´æ–° latest æ ‡ç­¾ï¼ˆå³ä½¿æ˜¯ beta ç‰ˆæœ¬ï¼‰"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  docker-release:
    name: Docker å‘å¸ƒ
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æ‰‹åŠ¨è§¦å‘æ—¶æ‰è¿è¡Œ
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: ç¡®è®¤è§¦å‘æ–¹å¼å’Œåˆ†æ”¯
        run: |
          echo "æ‰‹åŠ¨è§¦å‘ Docker å‘å¸ƒï¼Œä»åˆ†æ”¯ ${{ github.event.inputs.branch }} å‘å¸ƒ"
          echo "æŒ‡å®šç‰ˆæœ¬: ${{ github.event.inputs.version || 'è‡ªåŠ¨è·å–' }}"
          echo "å¼ºåˆ¶æ›´æ–° latest: ${{ github.event.inputs.force_latest }}"

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      # ä½¿ç”¨ Nx æ„å»ºæ‰€æœ‰é¡¹ç›®ï¼ˆç¡®ä¿ä¾èµ–é¡ºåºæ­£ç¡®ï¼‰
      - name: ä½¿ç”¨ Nx æ„å»ºé¡¹ç›®
        run: pnpm run build

      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬å·
            VERSION="${{ github.event.inputs.version }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬å·: $VERSION"
          else
            # ä» package.json è‡ªåŠ¨è·å–ç‰ˆæœ¬å·
            VERSION=$(node -p "require('./package.json').version")
            echo "ä» package.json è·å–ç‰ˆæœ¬å·: $VERSION"
          fi

          # ç”Ÿæˆå¸¦ v å‰ç¼€çš„ç‰ˆæœ¬å·ç”¨äº Docker æ ‡ç­¾
          VERSION_WITH_V="v$VERSION"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_with_v=$VERSION_WITH_V" >> $GITHUB_OUTPUT
          echo "Docker å‘å¸ƒç‰ˆæœ¬: $VERSION_WITH_V"

      - name: ç¡®å®šåˆ†æ”¯ç±»å‹
        id: branch_info
        run: |
          if [ "${{ github.event.inputs.branch }}" = "main" ]; then
            echo "branch_type=stable" >> $GITHUB_OUTPUT
            echo "is_main_branch=true" >> $GITHUB_OUTPUT
            echo "åˆ†æ”¯ç±»å‹: stable (main)"
          else
            echo "branch_type=beta" >> $GITHUB_OUTPUT
            echo "is_main_branch=false" >> $GITHUB_OUTPUT
            echo "åˆ†æ”¯ç±»å‹: beta"
          fi

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: ç”Ÿæˆ Docker æ ‡ç­¾
        id: docker_tags
        run: |
          USERNAME="${{ secrets.DOCKER_USERNAME }}"
          VERSION="${{ steps.get_version.outputs.version }}"
          VERSION_WITH_V="${{ steps.get_version.outputs.version_with_v }}"
          BRANCH_TYPE="${{ steps.branch_info.outputs.branch_type }}"
          IS_MAIN="${{ steps.branch_info.outputs.is_main_branch }}"
          FORCE_LATEST="${{ github.event.inputs.force_latest }}"

          # åŸºç¡€æ ‡ç­¾ï¼šç‰ˆæœ¬å·ï¼ˆå¸¦ v å‰ç¼€ï¼‰å’Œåˆ†æ”¯ç±»å‹
          TAGS="$USERNAME/xiaozhi-client:$VERSION_WITH_V,$USERNAME/xiaozhi-client:$BRANCH_TYPE"

          # å¦‚æœæ˜¯ main åˆ†æ”¯æˆ–å¼ºåˆ¶æ›´æ–° latestï¼Œæ·»åŠ  latest æ ‡ç­¾
          if [ "$IS_MAIN" = "true" ] || [ "$FORCE_LATEST" = "true" ]; then
            TAGS="$TAGS,$USERNAME/xiaozhi-client:latest"
          fi

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆçš„ Docker æ ‡ç­¾:"
          echo "$TAGS" | tr ',' '\n' | sed 's/^/  - /'

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            XIAOZHI_VERSION=${{ steps.get_version.outputs.version }}
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: å‘å¸ƒæ€»ç»“
        run: |
          echo "ğŸ‰ Docker é•œåƒå‘å¸ƒå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ å‘å¸ƒä¿¡æ¯:"
          echo "  ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version_with_v }}"
          echo "  åˆ†æ”¯: ${{ github.event.inputs.branch }}"
          echo "  åˆ†æ”¯ç±»å‹: ${{ steps.branch_info.outputs.branch_type }}"
          echo ""
          echo "ğŸ·ï¸ Docker æ ‡ç­¾:"
          echo "${{ steps.docker_tags.outputs.tags }}" | tr ',' '\n' | sed 's/^/  - /'
          echo ""
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
          echo "  docker pull ${{ secrets.DOCKER_USERNAME }}/xiaozhi-client:${{ steps.get_version.outputs.version_with_v }}"
          echo "  docker run -it ${{ secrets.DOCKER_USERNAME }}/xiaozhi-client:${{ steps.get_version.outputs.version_with_v }}"
