name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "å‘å¸ƒç±»å‹"
        required: true
        default: "beta-patch"
        type: choice
        options:
          - "release-patch" # æ­£å¼ç‰ˆ patch
          - "release-minor" # æ­£å¼ç‰ˆ minor
          - "release-major" # æ­£å¼ç‰ˆ major
          - "beta-patch" # Beta é¢„å‘å¸ƒ patch
          - "beta-minor" # Beta é¢„å‘å¸ƒ minor
          - "beta-major" # Beta é¢„å‘å¸ƒ major
          - "rc-patch" # RC é¢„å‘å¸ƒ patch
          - "rc-minor" # RC é¢„å‘å¸ƒ minor
          - "rc-major" # RC é¢„å‘å¸ƒ major
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  # æ–°å¢ï¼šCodeQL å®‰å…¨æ‰«æä½œä¸š
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          config-file: ./.github/codeql/codeql-config.yml # å¯é€‰ï¼šè‡ªå®šä¹‰é…ç½®

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºé¡¹ç›®
        run: pnpm build # å¦‚æœæœ‰æ„å»ºæ­¥éª¤

      - name: æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: security-scan # ä¾èµ–å®‰å…¨æ‰«æå®Œæˆ
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "å‘å¸ƒç±»å‹: ${{ github.event.inputs.release_type }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # æ£€æŸ¥æ˜¯å¦åœ¨ä¸»åˆ†æ”¯
          if [[ "${{ github.event.inputs.release_type }}" == "release-"* ]] && [ "${{ github.ref_name }}" != "main" ] && [ "${{ github.ref_name }}" != "master" ]; then
            if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è§£æå‘å¸ƒå‚æ•°
        id: parse-release
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          if [[ "$RELEASE_TYPE" == "release-"* ]]; then
            # æ­£å¼ç‰ˆå‘å¸ƒ
            VERSION_TYPE="release"
            VERSION_INCREMENT="${RELEASE_TYPE#release-}"
            PRERELEASE_ID=""
          elif [[ "$RELEASE_TYPE" == "beta-"* ]]; then
            # Beta é¢„å‘å¸ƒç‰ˆ
            VERSION_TYPE="prerelease"
            VERSION_INCREMENT="${RELEASE_TYPE#beta-}"
            PRERELEASE_ID="beta"
          elif [[ "$RELEASE_TYPE" == "rc-"* ]]; then
            # RC é¢„å‘å¸ƒç‰ˆ
            VERSION_TYPE="prerelease"
            VERSION_INCREMENT="${RELEASE_TYPE#rc-}"
            PRERELEASE_ID="rc"
          else
            # å…œåº•å¤„ç†
            VERSION_TYPE="prerelease"
            VERSION_INCREMENT="patch"
            PRERELEASE_ID="beta"
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "version_increment=$VERSION_INCREMENT" >> $GITHUB_OUTPUT
          echo "prerelease_id=$PRERELEASE_ID" >> $GITHUB_OUTPUT

      - name: ğŸ”’ å®‰å…¨å®¡è®¡æ£€æŸ¥
        run: |
          pnpm audit --audit-level moderate

      - name: å‘å¸ƒ
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          RELEASE_CMD="npx release-it"

          if [ "${{ steps.parse-release.outputs.version_type }}" = "release" ]; then
            # æ­£å¼ç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD ${{ steps.parse-release.outputs.version_increment }}"
          else
            # é¢„å‘å¸ƒç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD ${{ steps.parse-release.outputs.version_increment }} --preRelease=${{ steps.parse-release.outputs.prerelease_id }}"
          fi

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            RELEASE_CMD="$RELEASE_CMD --dry-run"
          fi

          echo "æ‰§è¡Œå‘½ä»¤: $RELEASE_CMD"
          eval $RELEASE_CMD
