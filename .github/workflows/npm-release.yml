name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "å‘å¸ƒç±»å‹"
        required: true
        default: "beta-patch"
        type: choice
        options:
          - "release-patch" # æ­£å¼ç‰ˆ patch
          - "release-minor" # æ­£å¼ç‰ˆ minor
          - "release-major" # æ­£å¼ç‰ˆ major
          - "beta-patch" # Beta é¢„å‘å¸ƒ patch
          - "beta-minor" # Beta é¢„å‘å¸ƒ minor
          - "beta-major" # Beta é¢„å‘å¸ƒ major
          - "rc-patch" # RC é¢„å‘å¸ƒ patch
          - "rc-minor" # RC é¢„å‘å¸ƒ minor
          - "rc-major" # RC é¢„å‘å¸ƒ major
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  contents: read

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "å‘å¸ƒç±»å‹: ${{ github.event.inputs.release_type }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # æ£€æŸ¥æ˜¯å¦åœ¨ä¸»åˆ†æ”¯
          if [[ "${{ github.event.inputs.release_type }}" == "release-"* ]] && [ "${{ github.ref_name }}" != "main" ] && [ "${{ github.ref_name }}" != "master" ]; then
            if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è§£æå‘å¸ƒå‚æ•°
        id: parse-release
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          if [[ "$RELEASE_TYPE" == "release-"* ]]; then
            # æ­£å¼ç‰ˆå‘å¸ƒ
            VERSION_TYPE="release"
            VERSION_INCREMENT="${RELEASE_TYPE#release-}"
            PRERELEASE_ID=""
          elif [[ "$RELEASE_TYPE" == "beta-"* ]]; then
            # Beta é¢„å‘å¸ƒç‰ˆ
            VERSION_TYPE="prerelease"
            VERSION_INCREMENT="${RELEASE_TYPE#beta-}"
            PRERELEASE_ID="beta"
          elif [[ "$RELEASE_TYPE" == "rc-"* ]]; then
            # RC é¢„å‘å¸ƒç‰ˆ
            VERSION_TYPE="prerelease"
            VERSION_INCREMENT="${RELEASE_TYPE#rc-}"
            PRERELEASE_ID="rc"
          else
            # å…œåº•å¤„ç†
            VERSION_TYPE="prerelease"
            VERSION_INCREMENT="patch"
            PRERELEASE_ID="beta"
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "version_increment=$VERSION_INCREMENT" >> $GITHUB_OUTPUT
          echo "prerelease_id=$PRERELEASE_ID" >> $GITHUB_OUTPUT

      - name: ğŸ”’ å®‰å…¨å®¡è®¡æ£€æŸ¥
        id: security-audit
        run: |
          echo "ğŸ” å¼€å§‹æ‰§è¡Œå®‰å…¨å®¡è®¡æ£€æŸ¥..."
          
          # æ‰§è¡Œå®‰å…¨å®¡è®¡
          SECURITY_OUTPUT=$(pnpm audit --audit-level moderate --json)
          SECURITY_EXIT_CODE=$?
          
          echo "å®‰å…¨å®¡è®¡é€€å‡ºç : $SECURITY_EXIT_CODE"
          echo "å®‰å…¨å®¡è®¡è¾“å‡º:"
          echo "$SECURITY_OUTPUT"
          
          if [ $SECURITY_EXIT_CODE -eq 0 ]; then
            echo "âœ… å®‰å…¨å®¡è®¡é€šè¿‡ï¼šæœªå‘ç°ä¸­å±åŠä»¥ä¸Šçº§åˆ«çš„å®‰å…¨æ¼æ´"
            echo "security_audit_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  å®‰å…¨å®¡è®¡æœªé€šè¿‡ï¼šå‘ç°ä¸­å±åŠä»¥ä¸Šçº§åˆ«çš„å®‰å…¨æ¼æ´"
            echo "security_audit_passed=false" >> $GITHUB_OUTPUT
            
            # å¦‚æœæ˜¯é¢„æ¼”æ¨¡å¼ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ä½†ç»§ç»­æ‰§è¡Œ
            if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
              echo "ğŸ“‹ é¢„æ¼”æ¨¡å¼ï¼šå‘ç°å®‰å…¨é—®é¢˜ä½†ç»§ç»­æ‰§è¡Œå‘å¸ƒæµç¨‹"
              echo "âš ï¸  è¯·åœ¨æ­£å¼å‘å¸ƒå‰ä¿®å¤ä»¥ä¸‹å®‰å…¨é—®é¢˜ï¼š"
              pnpm audit --audit-level moderate
              echo "security_audit_passed=true" >> $GITHUB_OUTPUT  # é¢„æ¼”æ¨¡å¼ä¸‹æ ‡è®°ä¸ºé€šè¿‡ä»¥ç»§ç»­
            else
              echo "âŒ æ­£å¼å‘å¸ƒæ¨¡å¼ï¼šå­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œåœæ­¢å‘å¸ƒæµç¨‹"
              echo "ğŸ”§ è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¤å®‰å…¨é—®é¢˜åé‡è¯•ï¼š"
              echo "   pnpm audit fix"
              echo "   pnpm audit --audit-level moderate"
              exit 1
            fi
          fi

      - name: å‘å¸ƒ
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          RELEASE_CMD="npx release-it"

          if [ "${{ steps.parse-release.outputs.version_type }}" = "release" ]; then
            # æ­£å¼ç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD ${{ steps.parse-release.outputs.version_increment }}"
          else
            # é¢„å‘å¸ƒç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD ${{ steps.parse-release.outputs.version_increment }} --preRelease=${{ steps.parse-release.outputs.prerelease_id }}"
          fi

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            RELEASE_CMD="$RELEASE_CMD --dry-run"
          fi

          echo "æ‰§è¡Œå‘½ä»¤: $RELEASE_CMD"
          eval $RELEASE_CMD
