name: CI Pipeline

# 触发条件：只在PR到main分支时运行CI
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # CI 阶段 - 完整的代码质量和测试检查
  ci:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['20.17.0', '20.19.2', '22.16.0']

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 启用 Corepack
      run: corepack enable

    - name: 安装 pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.13.1

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'

    - name: 安装依赖
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 2
        retry_on: error
        command: pnpm install --frozen-lockfile

    # 代码质量检查
    - name: Nx Lint
      run: npx nx run-many -t lint

    - name: Nx Type Check
      run: npx nx run-many -t type-check

    - name: 拼写检查 (根目录)
      run: pnpm run spell:check

    - name: 代码重复率检查 (backend)
      run: pnpm run duplicate:check

    # 构建和测试
    - name: Nx Build
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 2
        retry_on: error
        command: npx nx run-many -t build --parallel=false

    - name: Nx Test
      uses: nick-invision/retry@v3
      with:
        timeout_minutes: 10
        max_attempts: 2
        retry_on: error
        command: npx nx run-many -t test --coverage --parallel=true

    # 上传覆盖率（仅 Ubuntu + Node 20.19.2）
    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.node-version == '20.19.2'
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: |
          ./coverage/lcov.info
          ./apps/frontend/coverage/lcov.info
        flags: unittests
        name: codecov-${{ matrix.os }}-node${{ matrix.node-version }}
        fail_ci_if_error: true
        verbose: true

    # CLI 功能测试
    - name: CLI 功能测试
      run: |
        echo "开始 CLI 功能测试..."
        node dist/cli.js -v
        node dist/cli.js create myapp
        node dist/cli.js create myapp2 --template hello-world
        echo "✅ CLI 功能测试完成"

    - name: CLI 配置测试 (Unix)
      if: runner.os != 'Windows'
      working-directory: myapp2
      run: |
        node ../dist/cli.js config set mcpEndpoint "wss://api.xiaozhi.me/mcp/?token=xyz"
        node ../dist/cli.js config get mcpEndpoint
        echo "✅ CLI 配置测试完成"

    - name: CLI 配置测试 (Windows)
      if: runner.os == 'Windows'
      working-directory: myapp2
      run: |
        node ../dist/cli.js config set mcpEndpoint "wss://api.xiaozhi.me/mcp/?token=xyz"
        node ../dist/cli.js config get mcpEndpoint
        echo "✅ CLI 配置测试完成"
      shell: pwsh

    # 上传构建产物
    - name: 上传覆盖率报告
      uses: actions/upload-artifact@v4
      if: always() && matrix.os == 'ubuntu-latest' && matrix.node-version == '20.19.2'
      with:
        name: coverage-report-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          coverage/
          apps/frontend/coverage/
        retention-days: 30

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: build-artifacts-${{ matrix.os }}-node${{ matrix.node-version }}
        path: |
          dist/
          apps/frontend/dist/
        retention-days: 7
