# .github/workflows/ai-fix-bot.yml
name: AI Fix Bot (Claude Code + GLM-4.7)

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  ai-fix:
    # åªåœ¨è¢« @fixit æåŠæ—¶è§¦å‘
    if: |
      contains(github.event.comment.body, '@xiaozhi') ||
      contains(github.event.issue.body, '@xiaozhi')
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å¯ç”¨ Corepack
        run: corepack enable

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.2'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: å®‰è£… Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: é…ç½® Claude Code ä½¿ç”¨ GLM-4.7
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
        run: |
          mkdir -p ~/.claude
          cat > ~/.claude/settings.json << 'EOF'
          {
            "env": {
              "ANTHROPIC_AUTH_TOKEN": "${ZHIPU_API_KEY}",
              "ANTHROPIC_BASE_URL": "https://open.bigmodel.cn/api/anthropic",
              "API_TIMEOUT_MS": "3000000",
              "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1
            }
          }
          EOF

          cat > ~/.claude.json << 'EOF'
          {
            "hasCompletedOnboarding": true
          }
          EOF

      - name: æå– Issue å†…å®¹
        id: extract
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # åˆå¹¶ Issue body å’Œ comment body
          BODY="${ISSUE_BODY:-}"
          if [ -n "${COMMENT_BODY:-}" ]; then
            BODY="$BODY"$'\n\n'"$COMMENT_BODY"
          fi

          # ç§»é™¤ @fixit è§¦å‘è¯
          CONTENT=$(echo "$BODY" | sed 's/@fixit//g')

          # ä¿å­˜åˆ°æ–‡ä»¶
          printf '%s' "$CONTENT" > /tmp/issue_request.md

          # è®¾ç½®è¾“å‡ºå˜é‡ï¼ˆä½¿ç”¨ GITHUB_OUTPUT æ–‡ä»¶ï¼‰
          {
            echo 'title<<EOF'
            printf '%s' "${{ github.event.issue.title }}"
            echo 'EOF'
            echo 'content_file=/tmp/issue_request.md'
            echo 'issue_number='"$ISSUE_NUMBER"
          } >> "$GITHUB_OUTPUT"

      - name: åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          BRANCH_NAME="ai-fix/issue-${ISSUE_NUMBER}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: ä½¿ç”¨ Claude Code åˆ†æå’Œä¿®å¤
        id: ai_fix
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # åˆ›å»ºå®‰å…¨çš„æç¤ºè¯æ–‡ä»¶
          cat > /tmp/claude_prompt.txt << 'PROMPT_EOF'
          ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç ä¿®å¤åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹ GitHub Issue å¹¶ä¿®å¤ç›¸å…³é—®é¢˜ï¼š

          Issue æ ‡é¢˜ï¼šISSUE_TITLE_PLACEHOLDER

          Issue å†…å®¹è¯·æŸ¥çœ‹æ–‡ä»¶ï¼š/tmp/issue_request.md

          è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
          1. å…ˆä½¿ç”¨ /init å‘½ä»¤åˆå§‹åŒ–é¡¹ç›®ç†è§£
          2. åˆ†æé—®é¢˜æ ¹å› 
          3. åˆ¶å®šä¿®å¤è®¡åˆ’
          4. å®æ–½ä¿®å¤
          5. è¿è¡Œ pnpm lintã€pnpm check:typeã€pnpm test éªŒè¯ä¿®å¤
          6. ç¡®ä¿æ‰€æœ‰æ£€æŸ¥é€šè¿‡

          æ³¨æ„ï¼š
          - åªä¿®æ”¹å¿…è¦çš„æ–‡ä»¶
          - éµå¾ªé¡¹ç›®çš„ç¼–ç è§„èŒƒï¼ˆå‚è§ CLAUDE.mdï¼‰
          - æ‰€æœ‰æ³¨é‡Šå’Œç”¨æˆ·ç•Œé¢æ–‡æœ¬å¿…é¡»ä½¿ç”¨ä¸­æ–‡
          - ä½¿ç”¨é¡¹ç›®è·¯å¾„åˆ«åç³»ç»Ÿ
          PROMPT_EOF

          # æ›¿æ¢æ ‡é¢˜å ä½ç¬¦ï¼ˆä½¿ç”¨ sedï¼Œé¿å…å˜é‡æ›¿æ¢é—®é¢˜ï¼‰
          sed -i "s/ISSUE_TITLE_PLACEHOLDER/$ISSUE_TITLE/g" /tmp/claude_prompt.txt

          # æ‰§è¡Œ Claude Codeï¼ˆheadless æ¨¡å¼ + è‡ªåŠ¨æ¥å—ï¼‰
          claude -p "$(cat /tmp/claude_prompt.txt)" --dangerously-skip-permissions 2>&1 | tee /tmp/claude_output.log

          # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --quiet; then
            echo "no_changes=true" >> $GITHUB_ENV
          else
            echo "no_changes=false" >> $GITHUB_ENV
          fi

      - name: è¿è¡Œè´¨é‡æ£€æŸ¥
        if: env.no_changes == 'false'
        run: |
          pnpm run lint
          pnpm run check:type
          pnpm run test
          pnpm run build

      - name: æäº¤ä¿®å¤
        if: env.no_changes == 'false'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          git config user.email "noreply@anthropic.com"
          git config user.name "Claude Bot"

          git add -A

          # ä½¿ç”¨ heredoc åˆ›å»ºå®‰å…¨çš„æäº¤æ¶ˆæ¯
          git commit -m "$(cat <<COMMIT_EOF
          fix: ç”± AI ä¿®å¤ Issue #${ISSUE_NUMBER}

          - ä½¿ç”¨ Claude Code + GLM-4.7 è‡ªåŠ¨ä¿®å¤
          - Issue: ${ISSUE_TITLE}

          Co-Authored-By: Claude Code <noreply@anthropic.com>
          COMMIT_EOF
          )"

          git push origin "${{ env.branch_name }}"

      - name: åˆ›å»º Pull Request
        id: create_pr
        if: env.no_changes == 'false'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ env.branch_name }}
          title: "ğŸ¤– AI Fix: ${{ env.issue_title }}"
          body: |
            ## AI è‡ªåŠ¨ä¿®å¤ PR

            æ­¤ PR ç”± Claude Code + GLM-4.7 è‡ªåŠ¨ç”Ÿæˆå¹¶ä¿®å¤ã€‚

            ### å…³è” Issue
            Closes #${{ env.issue_number }}

            ### Issue æ ‡é¢˜
            ${{ env.issue_title }}

            ### ä¿®å¤è¯´æ˜
            - ä½¿ç”¨ Claude Code CLI åˆ†æé—®é¢˜
            - æ¨¡å‹ï¼šGLM-4.7 (æ™ºè°± AI)
            - å·²é€šè¿‡å®Œæ•´çš„è´¨é‡æ£€æŸ¥ï¼šlintã€type-checkã€testã€build

            ### æ£€æŸ¥æ¸…å•
            - [x] ä»£ç é€šè¿‡ lint æ£€æŸ¥
            - [x] ä»£ç é€šè¿‡ç±»å‹æ£€æŸ¥
            - [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡
            - [x] æ„å»ºæˆåŠŸ
            - [x] éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ
          draft: false

      - name: æ·»åŠ æˆåŠŸè¯„è®º
        if: env.no_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const prUrl = '${{ steps.create_pr.outputs.pull-request-url }}';
            const body = `âœ… **AI ä¿®å¤æˆåŠŸ**\n\nå·²åˆ›å»º PRï¼š${prUrl}\n\nè¯·äººå·¥å®¡æŸ¥ä¿®å¤å†…å®¹ååˆå¹¶ã€‚`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: æ·»åŠ æ— ä¿®æ”¹è¯„è®º
        if: env.no_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `â„¹ï¸ **AI åˆ†æå®Œæˆ**\n\nClaude Code å·²åˆ†æè¯¥é—®é¢˜ï¼Œä½†æœªè¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚\n\nå¯èƒ½åŸå› ï¼š\n- é—®é¢˜ä¸éœ€è¦ä»£ç ä¿®æ”¹\n- é…ç½®æˆ–ç¯å¢ƒé—®é¢˜\n- éœ€è¦æ›´å¤šä¿¡æ¯æ‰èƒ½ä¿®å¤\n\nè¯·æŸ¥çœ‹å®Œæ•´çš„å·¥ä½œæµæ—¥å¿—ã€‚`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: æ·»åŠ å¤±è´¥è¯„è®º
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `âŒ **AI ä¿®å¤å¤±è´¥**\n\nè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
