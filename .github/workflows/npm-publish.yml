name: NPM å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "ç›®æ ‡ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.target_version }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š"
            echo "   - æ­£å¼ç‰ˆ: 1.0.0"
            echo "   - Betaç‰ˆ: 1.0.0-beta.0"
            echo "   - RCç‰ˆ: 1.0.0-rc.0"
            exit 1
          fi

          # æ£€æŸ¥åˆ†æ”¯æƒé™ï¼ˆå…è®¸åœ¨featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•å‘å¸ƒï¼‰
          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            if [ "${{ github.ref_name }}" != "main" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: è§£æç‰ˆæœ¬å·å‚æ•°
        id: parse-version
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"

          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # æ­£å¼ç‰ˆ: 1.0.0
            VERSION_TYPE="release"
            PRERELEASE_ID=""
            echo "æ£€æµ‹åˆ°æ­£å¼ç‰ˆç‰ˆæœ¬å·: $TARGET_VERSION"
          elif [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-beta\.[0-9]+$ ]]; then
            # Beta ç‰ˆ: 1.0.0-beta.0
            VERSION_TYPE="prerelease"
            PRERELEASE_ID="beta"
            echo "æ£€æµ‹åˆ°Betaç‰ˆæœ¬å·: $TARGET_VERSION"
          elif [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$ ]]; then
            # RC ç‰ˆ: 1.0.0-rc.0
            VERSION_TYPE="prerelease"
            PRERELEASE_ID="rc"
            echo "æ£€æµ‹åˆ°RCç‰ˆæœ¬å·: $TARGET_VERSION"
          else
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ³•è¯†åˆ«"
            exit 1
          fi

          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          echo "prerelease_id=$PRERELEASE_ID" >> $GITHUB_OUTPUT

      - name: ğŸ”’ å®‰å…¨å®¡è®¡æ£€æŸ¥
        run: |
          pnpm audit --audit-level moderate

      - name: å‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_VERSION="${{ steps.parse-version.outputs.target_version }}"
          RELEASE_CMD="npx release-it --ci"

          if [ "${{ steps.parse-version.outputs.version_type }}" = "release" ]; then
            # æ­£å¼ç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD -i $TARGET_VERSION"
          else
            # é¢„å‘å¸ƒç‰ˆå‘å¸ƒ
            RELEASE_CMD="$RELEASE_CMD $TARGET_VERSION --preRelease=${{ steps.parse-version.outputs.prerelease_id }}"
          fi

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            RELEASE_CMD="$RELEASE_CMD --dry-run"
          fi

          echo "ğŸ“¦ å¼€å§‹å‘å¸ƒæµç¨‹..."
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          echo "   - ç›®æ ‡ç‰ˆæœ¬: $TARGET_VERSION"
          echo "   - ç‰ˆæœ¬ç±»å‹: ${{ steps.parse-version.outputs.version_type }}"
          echo "   - é¢„å‘å¸ƒID: ${{ steps.parse-version.outputs.prerelease_id }}"
          echo "   - å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          echo "   - æ‰§è¡Œå‘½ä»¤: $RELEASE_CMD"
          echo ""

          # æ£€æŸ¥ç¯å¢ƒ
          echo "ğŸ” ç¯å¢ƒæ£€æŸ¥ï¼š"
          echo "   - Nodeç‰ˆæœ¬: $(node --version)"
          echo "   - pnpmç‰ˆæœ¬: $(pnpm --version)"
          echo "   - GitçŠ¶æ€: $(git status --porcelain | wc -l) ä¸ªæ–‡ä»¶æœ‰ä¿®æ”¹"
          echo "   - å½“å‰åˆ†æ”¯: $(git branch --show-current)"
          echo "   - æœ€æ–°æ ‡ç­¾: $(git describe --tags --match='v*' --abbrev=0 || echo 'æ— æ ‡ç­¾')"
          echo ""

          # æ‰§è¡Œå‘å¸ƒå‘½ä»¤
          echo "ğŸš€ æ‰§è¡Œå‘å¸ƒå‘½ä»¤..."
          eval $RELEASE_CMD

          # æ£€æŸ¥æ‰§è¡Œç»“æœ
          if [ $? -eq 0 ]; then
          exit_code=$?

          # æ£€æŸ¥æ‰§è¡Œç»“æœ
          if [ $exit_code -eq 0 ]; then
            echo "âœ… å‘å¸ƒå‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ å‘å¸ƒå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé”™è¯¯ç : $exit_code"
