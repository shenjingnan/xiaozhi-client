---
title: Docker é•œåƒæ„å»ºæŒ‡å—
description: å°æ™ºå®¢æˆ·ç«¯ Docker å®¹å™¨åŒ–æ„å»ºçš„å®Œæ•´æŒ‡å—ï¼Œé€‚ç”¨äºè´¡çŒ®è€…å’Œå¼€å‘è€…
sidebar_position: 3
---

# Docker é•œåƒæ„å»ºæŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å°æ™ºå®¢æˆ·ç«¯é¡¹ç›®çš„ Docker å®¹å™¨åŒ–æ¶æ„å’Œæ„å»ºæµç¨‹ï¼Œå¸®åŠ©è´¡çŒ®è€…å’Œå¼€å‘è€…ç†è§£é¡¹ç›®çš„å®¹å™¨åŒ–è®¾è®¡ç†å¿µå’Œå‚ä¸å¼€å‘ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›® Docker æ¶æ„æ¦‚è§ˆ](#é¡¹ç›®-docker-æ¶æ„æ¦‚è§ˆ)
- [æ„å»ºæ–‡ä»¶è¯¦è§£](#æ„å»ºæ–‡ä»¶è¯¦è§£)
- [æ ¸å¿ƒæœºåˆ¶è§£æ](#æ ¸å¿ƒæœºåˆ¶è§£æ)
- [å¼€å‘å·¥ä½œæµ](#å¼€å‘å·¥ä½œæµ)
- [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## ğŸ—ï¸ é¡¹ç›® Docker æ¶æ„æ¦‚è§ˆ

### è®¾è®¡ç†å¿µ

å°æ™ºå®¢æˆ·ç«¯é‡‡ç”¨**åŒç¯å¢ƒ Docker æ¶æ„**ï¼Œé’ˆå¯¹ä¸åŒçš„ä½¿ç”¨åœºæ™¯æä¾›äº†ä¸“é—¨çš„è§£å†³æ–¹æ¡ˆï¼š

- **ç”Ÿäº§ç¯å¢ƒ**ï¼šåŸºäºé¢„å‘å¸ƒåŒ…ï¼Œæä¾›å¼€ç®±å³ç”¨çš„ç¨³å®šä½“éªŒ
- **å¼€å‘ç¯å¢ƒ**ï¼šæ”¯æŒæœ¬åœ°æ„å»ºï¼Œä¾¿äºè°ƒè¯•å’ŒåŠŸèƒ½å¼€å‘

### ç›®å½•ç»“æ„

é¡¹ç›®å°† Docker ç›¸å…³æ–‡ä»¶ç»„ç»‡åœ¨ç‹¬ç«‹çš„ `docker/` ç›®å½•ä¸­ï¼š

```
docker/
â”œâ”€â”€ .dockerignore              # ç”Ÿäº§ç¯å¢ƒæ„å»ºå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ .dockerignore.dev          # å¼€å‘ç¯å¢ƒæ„å»ºå¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ Dockerfile                 # ç”Ÿäº§ç¯å¢ƒé•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ Dockerfile.dev             # å¼€å‘ç¯å¢ƒé•œåƒæ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml         # ç”Ÿäº§ç¯å¢ƒå®¹å™¨ç¼–æ’
â”œâ”€â”€ docker-compose.dev.yml     # å¼€å‘ç¯å¢ƒå®¹å™¨ç¼–æ’
â”œâ”€â”€ scripts/                   # è„šæœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ entrypoint.sh          # å®¹å™¨å¯åŠ¨åˆå§‹åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ start.sh               # ä¸€é”®å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ update-version.js      # ç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°è„šæœ¬
â””â”€â”€ templates/                 # æ¨¡æ¿æ–‡ä»¶
    â”œâ”€â”€ mcpServers/            # MCP æœåŠ¡å™¨æ¨¡æ¿
    â”œâ”€â”€ package.json           # é¡¹ç›®æ¨¡æ¿é…ç½®
    â”œâ”€â”€ requirements.txt       # Python ä¾èµ–æ¨¡æ¿
    â””â”€â”€ xiaozhi.config.json    # é…ç½®æ–‡ä»¶æ¨¡æ¿
```

### æ¶æ„ç‰¹ç‚¹

```mermaid
graph TD
    A[å°æ™ºå®¢æˆ·ç«¯ Docker æ¶æ„] --> B[ç”Ÿäº§ç¯å¢ƒ]
    A --> C[å¼€å‘ç¯å¢ƒ]

    B --> D[åŸºäºé¢„å‘å¸ƒåŒ…]
    B --> E[è‡ªåŠ¨åŒ–æ„å»º]
    B --> F[å¤šå¹³å°æ”¯æŒ]

    C --> G[æœ¬åœ°æºç æ„å»º]
    C --> H[å¼€å‘å·¥å…·é›†æˆ]
    C --> I[çƒ­é‡è½½æ”¯æŒ]

    D --> J[å¿«é€Ÿéƒ¨ç½²]
    E --> K[CI/CD è‡ªåŠ¨åŒ–]
    F --> L[ARM64/AMD64]

    G --> M[è°ƒè¯•å‹å¥½]
    H --> N[å¼€å‘æ•ˆç‡]
    I --> O[å®æ—¶æ›´æ–°]
```

## ğŸ“¦ æ„å»ºæ–‡ä»¶è¯¦è§£

### å…³é”®å·®å¼‚

| ç‰¹æ€§ | ç”Ÿäº§ç¯å¢ƒ | å¼€å‘ç¯å¢ƒ |
|------|---------|---------|
| **åŸºç¡€åŒ…** | xiaozhi-client é¢„å‘å¸ƒåŒ… | æœ¬åœ°æºç æ„å»º |
| **ç”¨æˆ·æƒé™** | root ç”¨æˆ·è¿è¡Œ | é root ç”¨æˆ·(åç»­ä¼šä¿æŒä¸€è‡´) |
| **Python ç¯å¢ƒ** | å®Œæ•´è™šæ‹Ÿç¯å¢ƒ | æ—  Python ç¯å¢ƒ(åç»­ä¼šä¿æŒä¸€è‡´) |
| **å¯åŠ¨æ–¹å¼** | ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ | é€šè¿‡æºç è¿è¡Œ |
| **è°ƒè¯•æ”¯æŒ** | åŸºç¡€æ—¥å¿— | å®Œæ•´å¼€å‘å·¥å…·é“¾ |

## âš™ï¸ æ ¸å¿ƒæœºåˆ¶è§£æ

### å®¹å™¨å¯åŠ¨æµç¨‹

`entrypoint.sh` è„šæœ¬å®ç°äº†æ™ºèƒ½çš„å®¹å™¨åˆå§‹åŒ–æµç¨‹ï¼š

```mermaid
graph TD
    A[å®¹å™¨å¯åŠ¨] --> B{æ£€æŸ¥å·¥ä½œç›®å½•çŠ¶æ€}
    B -->|æ— é…ç½®æ–‡ä»¶| C[åˆå§‹åŒ–å·¥ä½œç›®å½•]
    B -->|å·²æœ‰é…ç½®| D[è·³è¿‡åˆå§‹åŒ–]

    C --> E[å¤åˆ¶æ¨¡æ¿æ–‡ä»¶]
    E --> F[æ£€æŸ¥ Node.js ä¾èµ–]
    D --> F

    F -->|æ—  node_modules| G[å®‰è£…ä¾èµ–]
    F -->|å·²å­˜åœ¨| H[è·³è¿‡å®‰è£…]
    G --> H

    H --> I[æ£€æŸ¥ Python ä¾èµ–]
    I -->|æœ‰è‡ªå®šä¹‰ requirements.txt| J[å®‰è£…ç”¨æˆ·ä¾èµ–]
    I -->|æ— è‡ªå®šä¹‰æ–‡ä»¶| K[æ£€æŸ¥é»˜è®¤ä¾èµ–]

    J --> L[æ¸…ç† PID æ–‡ä»¶]
    K -->|ç¼ºå°‘åŸºç¡€åŒ…| M[å®‰è£…é»˜è®¤ä¾èµ–]
    K -->|åŸºç¡€åŒ…å­˜åœ¨| L
    M --> L

    L --> N[å¯åŠ¨ xiaozhi-client]
```

### ç‰ˆæœ¬ç®¡ç†

`update-version.js` è„šæœ¬å®ç°äº†ç‰ˆæœ¬å·çš„è‡ªåŠ¨åŒæ­¥ï¼š

```javascript
// è‡ªåŠ¨æ›´æ–° Dockerfile ä¸­çš„ç‰ˆæœ¬å·
const version = process.argv[2] || require('../../package.json').version;

// æ›´æ–°ç”Ÿäº§ç¯å¢ƒ Dockerfile
const dockerfileContent = fs.readFileSync(dockerfilePath, 'utf8')
  .replace(/ARG XIAOZHI_VERSION=.*$/, `ARG XIAOZHI_VERSION=${version}`);

// æ›´æ–° docker-compose ç‰ˆæœ¬æ ‡ç­¾
const composeContent = fs.readFileSync(composePath, 'utf8')
  .replace(/image: shenjingnan\/xiaozhi-client:.*$/, `image: shenjingnan/xiaozhi-client:${version}`);
```

## ğŸš€ å¼€å‘å·¥ä½œæµ

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

1. **æ„å»ºå¼€å‘é•œåƒ**ï¼š
```bash
cd docker/
docker build -f Dockerfile.dev -t xiaozhi-client:dev .
```

2. **å¯åŠ¨å¼€å‘å®¹å™¨**ï¼š
```bash
docker-compose -f docker-compose.dev.yml up --build
```

3. **è°ƒè¯•å’Œå¼€å‘**ï¼š
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f xiaozhi-client-dev

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it xiaozhi-client-dev /bin/bash

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.dev.yml up --build --force-recreate
```

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **æ„å»ºç”Ÿäº§é•œåƒ**ï¼š
```bash
# æŒ‡å®šç‰ˆæœ¬å·æ„å»º
docker build --build-arg XIAOZHI_VERSION=1.6.1 -t shenjingnan/xiaozhi-client:1.6.1 .

# å¤šå¹³å°æ„å»ºï¼ˆæ”¯æŒ ARM64 å’Œ AMD64ï¼‰
docker buildx build --platform linux/amd64,linux/arm64 \
  --build-arg XIAOZHI_VERSION=1.6.1 \
  -t shenjingnan/xiaozhi-client:1.6.1 \
  --push .
```

2. **ä½¿ç”¨ Docker Compose**ï¼š
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨
docker-compose up -d

# æŒ‡å®šç‰ˆæœ¬å¯åŠ¨
XIAOZHI_VERSION=1.6.1 docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
docker-compose logs -f
```

### ç‰ˆæœ¬å‘å¸ƒæµç¨‹

1. **æ›´æ–°ç‰ˆæœ¬å·**ï¼š
```bash
# ä½¿ç”¨é¡¹ç›®è„šæœ¬è‡ªåŠ¨æ›´æ–°
pnpm docker:update-version 1.6.2

# æ‰‹åŠ¨æ›´æ–° package.json å’Œç›¸å…³æ–‡ä»¶
npm version patch
```

2. **è‡ªåŠ¨åŒ–æ„å»º**ï¼š

ä½¿ç”¨ Github å·¥ä½œæµ `.github/workflows/docker-publish.yml`

## è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**ï¼š
```bash
# å¯åŠ¨æ—¶æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
docker run --rm -it shenjingnan/xiaozhi-client:latest xiaozhi --help

# å®æ—¶æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f --tail=100 xiaozhi-client
```

2. **è¿›å…¥å®¹å™¨è°ƒè¯•**ï¼š
```bash
# è¿›å…¥è¿è¡Œä¸­çš„å®¹å™¨
docker exec -it xiaozhi-client /bin/bash

# æ£€æŸ¥ç¯å¢ƒé…ç½®
docker exec xiaozhi-client env | grep XIAOZHI
docker exec xiaozhi-client cat /workspaces/xiaozhi.config.json
```

3. **ç½‘ç»œè¿æ¥æµ‹è¯•**ï¼š
```bash
# æµ‹è¯•å®¹å™¨å†…ç½‘ç»œè¿æ¥
docker exec xiaozhi-client curl -I http://localhost:9999

# æ£€æŸ¥ç«¯å£æ˜ å°„
docker port xiaozhi-client
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Node.js æœ€ä½³å®è·µ](https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md)
- [å°æ™ºå®¢æˆ·ç«¯éƒ¨ç½²æ–‡æ¡£](/docs/usage/docker)

---

## ğŸ’¡ å‚ä¸è´¡çŒ®

æ¬¢è¿å‚ä¸å°æ™ºå®¢æˆ·ç«¯çš„ Docker ç›¸å…³å¼€å‘ï¼è¯·å‚è€ƒä»¥ä¸‹èµ„æºï¼š

- **æäº¤ Issue**ï¼šåœ¨ GitHub ä¸ŠæŠ¥å‘Š Bug æˆ–æå‡ºåŠŸèƒ½å»ºè®®
- **æäº¤ PR**ï¼šè´¡çŒ®ä»£ç æ”¹è¿›å’Œæ–‡æ¡£æ›´æ–°
- **è®¨è®ºäº¤æµ**ï¼šå‚ä¸æŠ€æœ¯è®¨è®ºå’Œæ–¹æ¡ˆè®¾è®¡

åœ¨æäº¤ Docker ç›¸å…³çš„æ”¹åŠ¨æ—¶ï¼Œè¯·ç¡®ä¿ï¼š
- éµå¾ªç°æœ‰çš„æ–‡ä»¶ç»„ç»‡ç»“æ„
- æ·»åŠ é€‚å½“çš„æ³¨é‡Šå’Œæ–‡æ¡£
- æµ‹è¯•åœ¨ä¸åŒç¯å¢ƒä¸‹çš„å…¼å®¹æ€§
- ä¿æŒä¸ç°æœ‰ CI/CD æµç¨‹çš„ä¸€è‡´æ€§
